# 比赛攻略 (Rapids团队 - C++实现)

## 1. 赛题背景分析及理解

### 赛题介绍

> 评测程序分为2个阶段：
  1）Recover正确性评测：
  此阶段评测程序会并发写入特定数据（key 8B、value 4KB）同时进行任意次kill -9来模拟进程意外退出（参赛引擎需要保证进程意外退出时数据持久化不丢失），接着重新打开DB，调用Read、Range接口来进行正确性校验

>  2）性能评测
>  -  随机写入：64个线程并发随机写入，每个线程使用Write各写100万次随机数据（key 8B、value 4KB）
>  -  随机读取：64个线程并发随机读取，每个线程各使用Read读取100万次随机数据
>  -  顺序读取：64个线程并发顺序读取，每个线程各使用Range有序（增序）遍历全量数据2次
>  注：
>  2.2阶段会对所有读取的kv校验是否匹配，如不通过则终止，评测失败；
>  2.3阶段除了对迭代出来每条的kv校验是否匹配外，还会额外校验是否严格递增，如不通过则终止，评测失败。

### 评测注意点

* Recover正确性评测要求: 每次Write调用都要将数据至少写入到page-cache。
* 每个阶段开始，DB Engine都会被重新打开。
* 每个阶段进行中， 只有读取或者写入中的一种情况发生。
* 每一阶段结束，page cache会被清空(清空page cache的时间占用总时间)。
* 对于复赛的顺序读取，recovery阶段使用单线程，并且只遍历全量数据1次，选手需要做相应处理。
* Key大小**固定**为`8B`， 根据`PolarString`定义, Key可以被转化为64bit-Big-Endian无符号整数表示，
Key分布比较随机，因此可按Key分Bucket来设计存储结构；
Value大小**固定**为`4KB`，因此在设计索引时候可以将偏移量直接除以`4KB`来减少空间占用。
* 评测中，允许使用的最大内存`2GB` (不计评测程序内存占用)；各子阶段会有固定的64线程随机写入或随机读取或顺序读取。

## 2. 核心思路

每一阶段结束，page cache会被清空。
因此，整体设计中除了内存映射文件(meta-file, key/val buffer files), 其他文件操作都通过DirectIO。

## 3. 关键代码

## 4. 比赛经验总结和感想